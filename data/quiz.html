<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz App</title>
  <link rel="stylesheet" href="stylesheet.css"> <!-- External styling -->
</head>
<body>

  <!-- ========== NAME ENTRY SCREEN ========== -->
  <div id="name-screen">
    <h1>Welcome to the Quizzy!</h1>
    <p>Please enter your name to begin:</p>
    <input type="text" id="name-input" placeholder="Enter your name" />
    <br>
    <button id="start-btn" onclick="startQuiz()">Start Quiz</button>
  </div>

  <!-- ========== LIVE SCORE & PROGRESS BAR ========== -->
  <div id="progress" style="display: none;">
    ‚úÖ Correct: 0 | ‚ùå Incorrect: 0<br>
    <span id="qprogress">Question 1/1</span>
    <div id="progress-bar"><div id="progress-bar-inner"></div></div>
  </div>

  <!-- ========== MAIN QUIZ AREA ========== -->
  <div id="quiz-container" style="display: none;">
    <h1>Quiz</h1>
    <div id="question-container">
      <div id="question">Loading...</div>
      <div id="options"></div>
    </div>
    <!-- End screen will replace question area when quiz is done -->
    <div id="end-screen" style="display: none;"></div>
  </div>

  <!-- ========== SOUND EFFECTS ========== -->
  <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
  <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>

  <!-- ========== FIREBASE + QUIZ SCRIPT ========== -->
  <script type="module">
    /* ---------------- FIREBASE SETUP ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWTOgHmlJmCtpb2LQ7g3wj_IMsTwyTNDE",
      authDomain: "quizzy-ea14d.firebaseapp.com",
      projectId: "quizzy-ea14d",
      storageBucket: "quizzy-ea14d.firebasestorage.app",
      messagingSenderId: "452576898646",
      appId: "1:452576898646:web:9fa8dbc2e106bcce8615f7",
      measurementId: "G-VKNVF4YZCB"
    };

    // Initialize Firebase App + Firestore database
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------- QUIZ VARIABLES ---------------- */
    let questions = [];           // Holds loaded questions
    let current = 0;              // Current question index
    let score = 0;                // Total correct answers
    let correctCount = 0;         // Number of correct answers
    let incorrectCount = 0;       // Number of wrong answers
    let questionAnswered = false; // Prevent double answering
    let userName = '';            // Name entered by the player
    let userResponses = [];       // Stores each question & answer for results

    /* ---------------- HELPER FUNCTION: Shuffle Array ---------------- */
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    /* ---------------- LOAD QUESTIONS FROM JSON FILE ---------------- */
    const urlParams = new URLSearchParams(window.location.search);
    const jsonFile = urlParams.get('json') || 'questions_cs.json';

    fetch(`https://singla1209.github.io/Quiz_App/${jsonFile}`)
      .then(res => res.json())
      .then(data => {
        questions = shuffleArray(data); // Randomize question order
      });

    /* ---------------- START QUIZ ---------------- */
    window.startQuiz = function() {
      const nameInput = document.getElementById("name-input").value.trim();
      if (!nameInput) {
        alert("Please enter your name.");
        return;
      }
      userName = nameInput;
      // Hide name screen, show quiz screen
      document.getElementById("name-screen").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      document.getElementById("progress").style.display = "block";
      showQuestion();
    }

    /* ---------------- SHOW A QUESTION ---------------- */
    function showQuestion() {
      questionAnswered = false; // Allow new click
      const q = questions[current]; // Current question object

      // Show question text
      document.getElementById("question").innerText = `Q${current + 1}. ${q.question}`;

      // Clear old options
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      // Create clickable options
      for (let key in q.options) {
        const div = document.createElement("div");
        div.className = "option";
        div.innerText = `${key}: ${q.options[key]}`;
        div.onclick = () => checkAnswer(key, div); // Pass clicked key & element
        optionsDiv.appendChild(div);
      }

      // Update progress text and bar
      document.getElementById("qprogress").innerText = `Question ${current + 1}/${questions.length}`;
      document.getElementById("progress-bar-inner").style.width = ((current + 1) / questions.length) * 100 + "%";
    }

    /* ---------------- CHECK ANSWER ---------------- */
    function checkAnswer(selected, divElement) {
      if (questionAnswered) return; // Ignore extra clicks
      questionAnswered = true;

      const correct = questions[current].correct; // Correct option key

      // Disable all options + color correct/wrong
      const allOptions = document.querySelectorAll(".option");
      allOptions.forEach(btn => {
        btn.style.pointerEvents = "none"; // Disable clicks
        if (btn.innerText.startsWith(correct + ":")) {
          btn.style.backgroundColor = "green"; // Correct answer
        } else if (btn === divElement) {
          btn.style.backgroundColor = "red";   // Wrong clicked answer
        }
      });

      // Save this question's details for the result page
      const questionText = questions[current].question;
      const selectedAnswer = questions[current].options[selected];
      const correctAnswer = questions[current].options[correct];
      userResponses.push({
        question: questionText,
        selected: selectedAnswer || "No answer",
        correct: correctAnswer
      });

      // Play sound + update score counts
      if (selected === correct) {
        score++;
        correctCount++;
        document.getElementById("correct-sound").play();
      } else {
        incorrectCount++;
        document.getElementById("wrong-sound").play();
      }

      updateLiveScore();

      // Auto-move to next question after 1 second
      setTimeout(() => {
        if (current < questions.length - 1) {
          current++;
          showQuestion();
        } else {
          showEndScreen();
        }
      }, 1000);
    }

    /* ---------------- UPDATE LIVE SCORE ---------------- */
    function updateLiveScore() {
      document.getElementById("progress").innerHTML =
        `‚úÖ Correct: ${correctCount} | ‚ùå Incorrect: ${incorrectCount}<br>
         <span id="qprogress">Question ${current + 1}/${questions.length}</span>
         <div id="progress-bar"><div id="progress-bar-inner" style="width: ${(current + 1) / questions.length * 100}%"></div></div>`;
    }

    /* ---------------- GENERATE RESULT GRAPHIC ---------------- */
    function generateResultGUI(correct, total) {
      let incorrect = total - correct;
      let percent = Math.round((correct / total) * 100);
      let circumference = 2 * Math.PI * 54;
      let offset = circumference - (percent / 100) * circumference;

      return `
      <h2>You're learning!</h2>
      <p>Next, practise your missed terms until you get them right.</p>
      <div style="display:flex;align-items:center;justify-content:center;gap:30px;margin-top:20px;">
          <div style="position:relative;width:120px;height:120px;">
              <svg width="120" height="120" style="transform:rotate(-90deg);">
                  <circle cx="60" cy="60" r="54" fill="none" stroke="#eee" stroke-width="12"></circle>
                  <circle cx="60" cy="60" r="54" fill="none" stroke="#00C49F" stroke-width="12" stroke-linecap="round"
                      stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
              </svg>
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:22px;font-weight:bold;">${percent}%</div>
          </div>
          <div>
              <div style="color:#00C49F;font-weight:bold;">Correct: ${correct}</div>
              <div style="color:#FF8042;font-weight:bold;">Incorrect: ${incorrect}</div>
          </div>
      </div>
      <div style="margin-top:30px;">
          <button style="background:#4f8ef7;color:white;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;margin-bottom:10px;width:80%;" onclick="alert('Practise missed terms!')">Practise ${incorrect} missed terms</button>
          <button style="background:#eee;color:#888;padding:12px 20px;border:none;border-radius:8px;width:80%;" disabled>üîí Take a new test</button>
          <button onclick="restartQuiz()" style="margin-top:10px;">Play Again</button>
          <button onclick="goToHome()" style="margin-top:10px;">Go to Home</button>
          <button onclick="window.location.href='result_deleted2.html'" style="margin-top:10px;">View All Results</button>
      </div>`;
    }

    /* ---------------- SHOW END SCREEN + SAVE TO FIREBASE ---------------- */
    async function showEndScreen() {
      document.getElementById("question-container").style.display = "none";
      document.getElementById("end-screen").style.display = "block";
      document.getElementById("end-screen").innerHTML = generateResultGUI(correctCount, questions.length);

      // Save results to Firebase
      try {
        await addDoc(collection(db, "quiz_results"), {
          name: userName,
          score: score,
          totalQuestions: questions.length,
          correctAnswers: correctCount,
          incorrectAnswers: incorrectCount,
          responses: userResponses,
          date: new Date().toISOString()
        });
        console.log("Result saved to Firebase!");
      } catch (error) {
        console.error("Error saving result:", error);
      }
    }

    /* ---------------- RESTART QUIZ ---------------- */
    window.restartQuiz = function() {
      current = 0;
      score = 0;
      correctCount = 0;
      incorrectCount = 0;
      userResponses = [];
      document.getElementById("end-screen").style.display = "none";
      document.getElementById("question-container").style.display = "block";
      showQuestion();
      updateLiveScore();
    }

    /* ---------------- GO TO HOME PAGE ---------------- */
    window.goToHome = function() {
      window.location.href = "https://singla1209.github.io/brain_quest/";
    }

    /* ---------------- DOWNLOAD RESULTS AS CSV ---------------- */
    window.downloadResults = function() {
      let csv = `Name:,${userName}\n\nQuestion,Your Answer,Correct Answer\n`;
      userResponses.forEach(r => {
        csv += `"${r.question}","${r.selected}","${r.correct}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${userName}_quiz_results.csv`;
      link.click();
    }
  </script>
</body>
</html>
