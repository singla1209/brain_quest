<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz App</title>
  <link rel="stylesheet" href="stylesheet.css">
</head>
<body>

  <!-- Name Screen -->
  <div id="name-screen">
    <h1>Welcome to the Quizzy!</h1>
    <p>Please enter your name to begin:</p>
    <input type="text" id="name-input" placeholder="Enter your name" />
    <br>
    <button id="start-btn" onclick="startQuiz()">Start Quiz</button>
  </div>

  <!-- Quiz Progress -->
  <div id="progress" style="display: none;">
    ✅ Correct: 0 | ❌ Incorrect: 0<br>
    <span id="qprogress">Question 1/1</span>
    <div id="progress-bar"><div id="progress-bar-inner"></div></div>
  </div>

  <!-- Main Quiz Container -->
  <div id="quiz-container" style="display: none;">
    <h1>Quiz</h1>
    <div id="question-container">
      <div id="question">Loading...</div>
      <div id="options"></div>
      <button id="next-btn" onclick="nextQuestion()">Next</button>
    </div>
    <div id="end-screen" style="display: none;">
      <h2>Quiz Completed!</h2>
      <p id="final-score"></p>
      <button onclick="downloadResults()">Download Result</button>
      <button onclick="restartQuiz()">Play Again</button>
      <button onclick="goToHome()">Go to Home</button>
      <button onclick="window.location.href='results.html'">View All Results</button>
    </div>
  </div>

  <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
  <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>

  <!-- Firebase SDK (v12) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWTOgHmlJmCtpb2LQ7g3wj_IMsTwyTNDE",
      authDomain: "quizzy-ea14d.firebaseapp.com",
      projectId: "quizzy-ea14d",
      storageBucket: "quizzy-ea14d.firebasestorage.app",
      messagingSenderId: "452576898646",
      appId: "1:452576898646:web:9fa8dbc2e106bcce8615f7",
      measurementId: "G-VKNVF4YZCB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Quiz Logic
    let questions = [];
    let current = 0;
    let score = 0;
    let correctCount = 0;
    let incorrectCount = 0;
    let questionAnswered = false;
    let userName = '';
    let userResponses = [];

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const jsonFile = urlParams.get('json') || 'questions_cs.json';

    fetch(`https://singla1209.github.io/Quiz_App/${jsonFile}`)
      .then(res => res.json())
      .then(data => {
        questions = shuffleArray(data);
      });

    window.startQuiz = function() {
      const nameInput = document.getElementById("name-input").value.trim();
      if (!nameInput) {
        alert("Please enter your name.");
        return;
      }
      userName = nameInput;
      document.getElementById("name-screen").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      document.getElementById("progress").style.display = "block";
      showQuestion();
    }

    function showQuestion() {
      questionAnswered = false;
      const q = questions[current];
      document.getElementById("question").innerText = `Q${current + 1}. ${q.question}`;

      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      for (let key in q.options) {
        const div = document.createElement("div");
        div.className = "option";
        div.innerText = `${key}: ${q.options[key]}`;
        div.onclick = () => checkAnswer(key, div);
        optionsDiv.appendChild(div);
      }

      document.getElementById("qprogress").innerText = `Question ${current + 1}/${questions.length}`;
      document.getElementById("progress-bar-inner").style.width = ((current + 1) / questions.length) * 100 + "%";
    }

    function checkAnswer(selected, divElement) {
      if (questionAnswered) return;
      questionAnswered = true;

      const correct = questions[current].correct;
      const allOptions = document.querySelectorAll(".option");
      allOptions.forEach(btn => {
        btn.style.pointerEvents = "none";
        if (btn.innerText.startsWith(correct + ":")) {
          btn.style.backgroundColor = "green";
        } else if (btn === divElement) {
          btn.style.backgroundColor = "red";
        }
      });

      const questionText = questions[current].question;
      const selectedAnswer = questions[current].options[selected];
      const correctAnswer = questions[current].options[correct];

      userResponses.push({
        question: questionText,
        selected: selectedAnswer || "No answer",
        correct: correctAnswer
      });

      if (selected === correct) {
        score++;
        correctCount++;
        document.getElementById("correct-sound").play();
      } else {
        incorrectCount++;
        document.getElementById("wrong-sound").play();
      }

      updateLiveScore();
    }

    function updateLiveScore() {
      document.getElementById("progress").innerHTML =
        `✅ Correct: ${correctCount} | ❌ Incorrect: ${incorrectCount}<br>
         <span id="qprogress">Question ${current + 1}/${questions.length}</span>
         <div id="progress-bar"><div id="progress-bar-inner" style="width: ${(current + 1) / questions.length * 100}%"></div></div>`;
    }

    window.nextQuestion = function() {
      if (!questionAnswered) {
        userResponses.push({
          question: questions[current].question,
          selected: "No answer",
          correct: questions[current].options[questions[current].correct]
        });
        incorrectCount++;
        updateLiveScore();
      }

      if (current < questions.length - 1) {
        current++;
        showQuestion();
      } else {
        showEndScreen();
      }
    }

    async function showEndScreen() {
      document.getElementById("question-container").style.display = "none";
      document.getElementById("end-screen").style.display = "block";
      document.getElementById("final-score").innerText = `${userName}, you got ${score} out of ${questions.length} correct.`;

      try {
        await addDoc(collection(db, "quiz_results"), {
          name: userName,
          score: score,
          totalQuestions: questions.length,
          correctAnswers: correctCount,
          incorrectAnswers: incorrectCount,
          responses: userResponses,
          date: new Date().toISOString()
        });
        console.log("Result saved to Firebase!");
      } catch (error) {
        console.error("Error saving result:", error);
      }
    }

    window.restartQuiz = function() {
      current = 0;
      score = 0;
      correctCount = 0;
      incorrectCount = 0;
      userResponses = [];
      document.getElementById("end-screen").style.display = "none";
      document.getElementById("question-container").style.display = "block";
      showQuestion();
      updateLiveScore();
    }

    window.goToHome = function() {
      window.location.href = "index.html";
    }

    window.downloadResults = function() {
      let csv = `Name:,${userName}\n\nQuestion,Your Answer,Correct Answer\n`;
      userResponses.forEach(r => {
        csv += `"${r.question}","${r.selected}","${r.correct}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${userName}_quiz_results.csv`;
      link.click();
    }
  </script>
</body>
</html>
